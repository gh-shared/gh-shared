name: Tag on Merge of Prepare PR

on:
  workflow_call:
    inputs:
      repository:
        description: 'Target repository'
        required: true
        type: string
      commit_message:
        description: 'The commit message to check'
        required: true
        type: string
      git_author_name:
        description: 'Git author name for commits (default: github-actions[bot])'
        required: false
        type: string
        default: 'github-actions[bot]'
      git_author_email:
        description: 'Git author email for commits (default: github-actions[bot]@users.noreply.github.com)'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
    outputs:
      version:
        description: 'Extracted version from commit message'
        value: ${{ jobs.tag-on-merge.outputs.version }}
    secrets:
      repo_token:
        description: 'GitHub token with repo permissions'
        required: true

permissions:
  contents: write

jobs:
  tag-on-merge:
    if: |
      startsWith(inputs.commit_message, 'chore: prepare v') ||
      contains(inputs.commit_message, 'chore: update CHANGELOG for v') ||
      (contains(inputs.commit_message, 'Merge pull request') && contains(inputs.commit_message, '/prepare-v'))
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          token: ${{ secrets.repo_token }}
          fetch-depth: 0

      - name: Extract version from commit message
        id: extract-version
        run: |
          COMMIT_MSG="${{ inputs.commit_message }}"
          echo "Processing commit message: $COMMIT_MSG"
          
          if [[ "$COMMIT_MSG" =~ chore:\ prepare\ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="v${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Extracted version: $VERSION"
          elif [[ "$COMMIT_MSG" =~ chore:\ update\ CHANGELOG\ for\ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="v${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Extracted version from CHANGELOG: $VERSION"
          elif [[ "$COMMIT_MSG" =~ Merge\ pull\ request.*prepare-v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="v${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Extracted version from merge PR: $VERSION"
          else
            echo "No valid prepare commit found in message: $COMMIT_MSG"
            exit 1
          fi

      - name: Check if tag already exists
        id: check-tag
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping tag creation"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag $VERSION does not exist, proceeding with creation"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Git Tag
        if: steps.check-tag.outputs.tag_exists == 'false'
        run: |
          git config user.name "${{ inputs.git_author_name }}"
          git config user.email "${{ inputs.git_author_email }}"
          VERSION="${{ steps.extract-version.outputs.version }}"
          git tag "$VERSION"
          git push origin "$VERSION"
          echo "Created and pushed tag: $VERSION"