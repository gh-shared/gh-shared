name: Prepare Release Branch

on:
  workflow_call:
    inputs:
      repository:
        description: 'Target repository (default: calling repo)'
        required: true
        type: string
      base_branch:
        description: 'Base branch for PR (default: master)'
        required: false
        type: string
        default: 'master'
      version:
        description: 'Version tag (e.g. v1.2.3)'
        required: true
        type: string
      package_files:
        description: 'JSON array of package.json files to update (e.g. ["package.json", "app/package.json"])'
        required: false
        type: string
        default: '[]'
      changelog_file:
        description: 'Path to changelog file (default: CHANGELOG.md)'
        required: false
        type: string
        default: 'CHANGELOG.md'
      git_author_name:
        description: 'Git author name for commits (default: github-actions[bot])'
        required: false
        type: string
        default: 'github-actions[bot]'
      git_author_email:
        description: 'Git author email for commits (default: github-actions[bot]@users.noreply.github.com)'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
      delete_existing_branch:
        description: 'Delete existing prepare branch if it exists (default: true)'
        required: false
        type: boolean
        default: true
    secrets:
      repo_token:
        description: 'GitHub token with repo and PR permissions'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          token: ${{ secrets.repo_token }}

      - name: Set up Git config
        run: |
          git config user.name "${{ inputs.git_author_name }}"
          git config user.email "${{ inputs.git_author_email }}"

      - name: Delete existing prepare branch if exists
        if: ${{ inputs.delete_existing_branch }}
        run: |
          BRANCH_NAME="prepare-${{ inputs.version }}"
          
          # Check if branch exists locally and delete it
          if git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
            echo "Local branch $BRANCH_NAME exists, deleting..."
            git branch -D $BRANCH_NAME
          fi
          
          # Check if branch exists on remote and delete it
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Remote branch $BRANCH_NAME exists, deleting..."
            git push origin --delete $BRANCH_NAME
          fi
          
          echo "Branch cleanup completed"

      - name: Extract version without "v"
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          STRIPPED_VERSION="${VERSION#v}"
          echo "STRIPPED_VERSION=$STRIPPED_VERSION" >> $GITHUB_ENV
          echo "stripped_version=$STRIPPED_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in package files
        run: |
          VERSION="$STRIPPED_VERSION"
          PACKAGE_FILES='${{ inputs.package_files }}'
          
          # Parse JSON array and update each file
          echo "$PACKAGE_FILES" | jq -r '.[]' | while read -r file; do
            if [ -f "$file" ]; then
              echo "Updating version in $file to $VERSION"
              jq --arg version "$VERSION" '.version = $version' "$file" > tmp && mv tmp "$file"
              git add "$file"
            else
              echo "Warning: File $file not found, skipping..."
            fi
          done
          
          # Commit changes if there are any
          if git diff --staged --quiet; then
            echo "No package files were updated"
          else
            git commit -m "chore: bump version to $VERSION"
          fi

      - name: Update or create changelog
        run: |
          VERSION="${{ inputs.version }}"
          TARGET_REPO="${{ inputs.repository }}"
          CHANGELOG_FILE="${{ inputs.changelog_file }}"
          
          # Create directory if it doesn't exist
          CHANGELOG_DIR=$(dirname "$CHANGELOG_FILE")
          if [ "$CHANGELOG_DIR" != "." ] && [ ! -d "$CHANGELOG_DIR" ]; then
            mkdir -p "$CHANGELOG_DIR"
          fi
          
          if [ -f "$CHANGELOG_FILE" ]; then
            # File exists, update it
            LINK_START=$(grep -m1 "^# v" "$CHANGELOG_FILE" | awk '{ print $2 }' || echo "")
            if [ -n "$LINK_START" ]; then
              CHANGELOG_HEADER="# $VERSION\n\nFor more information, see: [$LINK_START...$VERSION](https://github.com/$TARGET_REPO/compare/$LINK_START...$VERSION)\n"
            else
              CHANGELOG_HEADER="# $VERSION\n\nInitial release.\n"
            fi
            awk -v header="$CHANGELOG_HEADER" 'BEGIN {printf "%s", header} {print}' "$CHANGELOG_FILE" > tmp && mv tmp "$CHANGELOG_FILE"
            echo "Updated existing changelog: $CHANGELOG_FILE"
          else
            # File doesn't exist, create it
            echo "# $VERSION" > "$CHANGELOG_FILE"
            echo "" >> "$CHANGELOG_FILE"
            echo "Initial release." >> "$CHANGELOG_FILE"
            echo "Created new changelog: $CHANGELOG_FILE"
          fi
          
          git add "$CHANGELOG_FILE"
          git commit -m "chore: update changelog for $VERSION"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.repo_token }}
          commit-message: "chore: prepare ${{ inputs.version }}"
          branch: prepare-${{ inputs.version }}
          base: ${{ inputs.base_branch }}
          title: "chore: prepare ${{ inputs.version }}"
          body: |
            Update required files for the ${{ inputs.version }} release.

            **Changes included:**
            - Version bumped in package files
            - ${{ inputs.changelog_file }} updated with new version entry

            Please review and edit the content of `${{ inputs.changelog_file }}` if needed before merging.